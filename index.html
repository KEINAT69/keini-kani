<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keinap - Lessons & Reviews</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7fb; color: #111; }
    header { padding: 18px 16px; background: #111; color: #fff; }
    header h1 { margin: 0; font-size: 18px; }
    main { max-width: 980px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 1.2fr 0.8fr; }
    @media (max-width: 900px) { main { grid-template-columns: 1fr; } }

    .card { background: #fff; border: 1px solid #e7e7ee; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.05); overflow: hidden; }
    .card header { background: transparent; color: inherit; padding: 14px 14px 0 14px; }
    .card header h2 { margin: 0; font-size: 16px; }
    .card .content { padding: 14px; display: grid; gap: 10px; }

    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"] { flex: 1; min-width: 200px; padding: 10px 12px; border: 1px solid #d9d9e6; border-radius: 10px; }
    button { border: 1px solid #d0d0dd; background: #fff; padding: 10px 12px; border-radius: 10px; cursor: pointer; }
    button:hover { background: #f2f3f9; }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button.primary:hover { background: #222; }
    button.danger { border-color: #ffb3b3; }
    button.danger:hover { background: #fff0f0; }

    .list { display: grid; gap: 8px; }
    .item { border: 1px solid #ececf4; border-radius: 12px; padding: 10px; display: grid; gap: 8px; }
    .item-top { display: flex; justify-content: space-between; gap: 8px; align-items: center; }
    .muted { color: #666; font-size: 12px; }
    .pill { font-size: 12px; padding: 4px 8px; border: 1px solid #e3e3ef; border-radius: 999px; background: #fafafe; }
    .pill.good { border-color: #cde9d7; background: #f3fbf6; }
    .pill.due { border-color: #ffe3a6; background: #fff9ec; }

    .progress { height: 10px; background: #eee; border-radius: 999px; overflow: hidden; }
    .progress > div { height: 100%; width: 0%; background: #111; }

    .review-big { font-size: 15px; line-height: 1.35; }
    .btn-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    @media (max-width: 520px) { .btn-grid { grid-template-columns: 1fr 1fr; } }

    .kv { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .kv .box { border: 1px solid #ececf4; border-radius: 12px; padding: 10px; }
    .kv .box .k { font-size: 12px; color: #666; }
    .kv .box .v { font-size: 18px; font-weight: 700; margin-top: 2px; }

    textarea { width: 100%; min-height: 120px; padding: 10px 12px; border: 1px solid #d9d9e6; border-radius: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
  </style>
</head>
<body>
<header>
  <h1>Keinap — Lessons & Reviews (desde 0, estable)</h1>
</header>

<main>
  <!-- Lessons -->
  <section class="card" id="lessonsCard">
    <header><h2>Lessons</h2></header>
    <div class="content">
      <div class="row">
        <input id="newLessonText" type="text" placeholder="Nueva lección (ej: 10 verbos, kanji N5, etc.)" />
        <button class="primary" id="addLessonBtn">Agregar</button>
      </div>

      <div class="kv">
        <div class="box">
          <div class="k">Total</div>
          <div class="v" id="statTotal">0</div>
        </div>
        <div class="box">
          <div class="k">Aprendidas</div>
          <div class="v" id="statLearned">0</div>
        </div>
      </div>

      <div>
        <div class="muted" id="progressLabel">0% completado</div>
        <div class="progress"><div id="progressBar"></div></div>
      </div>

      <div class="list" id="lessonsList"></div>
    </div>
  </section>

  <!-- Reviews -->
  <section class="card" id="reviewsCard">
    <header><h2>Reviews</h2></header>
    <div class="content">
      <div class="muted">Reglas simples: solo se revisa lo “learned”. Intervalos: Again(0d), Hard(+1d), Good(+3d), Easy(+7d). Skip no cambia nada.</div>

      <div class="item">
        <div class="item-top">
          <span class="pill due" id="duePill">Due: 0</span>
          <span class="pill" id="queuePill">Queue: 0</span>
        </div>

        <div class="review-big" id="reviewPrompt">No hay items para repasar.</div>
        <div class="muted" id="reviewMeta"></div>

        <div class="btn-grid" id="reviewButtons">
          <button data-grade="again">Again</button>
          <button data-grade="hard">Hard</button>
          <button data-grade="good">Good</button>
          <button data-grade="easy">Easy</button>
          <button data-grade="skip">Skip</button>
        </div>
      </div>

      <div class="item">
        <div class="item-top">
          <div class="muted">Backup (export/import)</div>
        </div>
        <div class="row">
          <button id="exportBtn">Exportar JSON</button>
          <button id="importBtn">Importar JSON</button>
          <button class="danger" id="resetBtn">Reset total</button>
        </div>
        <textarea id="backupArea" placeholder="Aquí aparece el JSON al exportar. Para importar: pega JSON válido y presiona Importar."></textarea>
      </div>
    </div>
  </section>
</main>

<script>
/*
  Aviso de palabras reservadas (JavaScript):
  - const, let: declaración de variables (reservadas).
  - function: define funciones (reservada).
  - class: define clases (reservada, aquí no se usa).
  - return, if, for, switch: control de flujo (reservadas).
  No uses estos nombres como variables/funciones.
*/

(function () {
  'use strict';

  // ----------------------------
  // Estado + persistencia
  // ----------------------------
  const STORAGE_KEY = 'keinap_lessons_v1';

  /** @typedef {{ id: string, text: string, learned: boolean, createdAt: number, learnedAt: number|null, dueAt: number|null, reps: number, lastGrade: string|null }} Lesson */

  /** @type {{ lessons: Lesson[] }} */
  let state = loadState();

  function nowMs() { return Date.now(); }
  function daysToMs(days) { return days * 24 * 60 * 60 * 1000; }

  function uid() {
    // id simple y suficiente para front local
    return Math.random().toString(16).slice(2) + '-' + Math.random().toString(16).slice(2);
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { lessons: [] };
      const parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.lessons)) return { lessons: [] };
      return { lessons: parsed.lessons };
    } catch {
      return { lessons: [] };
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // ----------------------------
  // Selectores DOM
  // ----------------------------
  const el = {
    newLessonText: document.getElementById('newLessonText'),
    addLessonBtn: document.getElementById('addLessonBtn'),
    lessonsList: document.getElementById('lessonsList'),
    statTotal: document.getElementById('statTotal'),
    statLearned: document.getElementById('statLearned'),
    progressLabel: document.getElementById('progressLabel'),
    progressBar: document.getElementById('progressBar'),

    reviewPrompt: document.getElementById('reviewPrompt'),
    reviewMeta: document.getElementById('reviewMeta'),
    duePill: document.getElementById('duePill'),
    queuePill: document.getElementById('queuePill'),
    reviewButtons: document.getElementById('reviewButtons'),

    exportBtn: document.getElementById('exportBtn'),
    importBtn: document.getElementById('importBtn'),
    resetBtn: document.getElementById('resetBtn'),
    backupArea: document.getElementById('backupArea'),
  };

  // ----------------------------
  // Lógica Lessons
  // ----------------------------
  function addLesson(text) {
    const trimmed = String(text || '').trim();
    if (!trimmed) return;

    /** @type {Lesson} */
    const lesson = {
      id: uid(),
      text: trimmed,
      learned: false,
      createdAt: nowMs(),
      learnedAt: null,
      dueAt: null,           // solo aplica cuando learned=true
      reps: 0,
      lastGrade: null
    };

    state.lessons.unshift(lesson);
    saveState();
    renderAll();
  }

  function toggleLearned(id) {
    const lesson = state.lessons.find(l => l.id === id);
    if (!lesson) return;

    lesson.learned = !lesson.learned;

    if (lesson.learned) {
      lesson.learnedAt = nowMs();
      // al volverse learned, queda due inmediatamente (para que aparezca en Reviews)
      lesson.dueAt = nowMs();
      lesson.reps = lesson.reps || 0;
      lesson.lastGrade = lesson.lastGrade || null;
    } else {
      // si deja de ser learned, ya no participa en Reviews
      lesson.learnedAt = null;
      lesson.dueAt = null;
      lesson.reps = 0;
      lesson.lastGrade = null;
    }

    saveState();
    renderAll();
  }

  function deleteLesson(id) {
    state.lessons = state.lessons.filter(l => l.id !== id);
    saveState();
    renderAll();
  }

  // ----------------------------
  // Lógica Reviews (cola)
  // ----------------------------
  function getLearnedLessons() {
    return state.lessons.filter(l => l.learned);
  }

  function getDueLessons() {
    const t = nowMs();
    return getLearnedLessons().filter(l => (l.dueAt ?? 0) <= t);
  }

  function getNextReviewCandidate() {
    // Estrategia estable: primero due, ordenados por dueAt asc, luego createdAt asc
    const due = getDueLessons()
      .slice()
      .sort((a, b) => (a.dueAt ?? 0) - (b.dueAt ?? 0) || a.createdAt - b.createdAt);

    if (due.length > 0) return due[0];

    // Si no hay due, no mostramos nada (evita “cola fantasma”)
    return null;
  }

  function applyReviewGrade(id, grade) {
    const lesson = state.lessons.find(l => l.id === id);
    if (!lesson || !lesson.learned) return;

    const t = nowMs();

    // Skip: no altera calendario
    if (grade === 'skip') {
      saveState();
      renderAll();
      return;
    }

    // Intervalos simples (días)
    const intervals = {
      again: 0,
      hard: 1,
      good: 3,
      easy: 7,
    };

    const addDays = intervals[grade];
    if (typeof addDays !== 'number') return;

    lesson.reps = (lesson.reps || 0) + 1;
    lesson.lastGrade = grade;
    lesson.dueAt = t + daysToMs(addDays);

    saveState();
    renderAll();
  }

  // ----------------------------
  // Render
  // ----------------------------
  function fmtDate(ms) {
    if (!ms) return '-';
    const d = new Date(ms);
    return d.toLocaleString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
  }

  function renderStats() {
    const total = state.lessons.length;
    const learned = state.lessons.filter(l => l.learned).length;
    el.statTotal.textContent = String(total);
    el.statLearned.textContent = String(learned);

    const pct = total === 0 ? 0 : Math.round((learned / total) * 100);
    el.progressLabel.textContent = `${pct}% completado`;
    el.progressBar.style.width = `${pct}%`;
  }

  function renderLessonsList() {
    el.lessonsList.innerHTML = '';

    if (state.lessons.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = 'No hay lecciones todavía.';
      el.lessonsList.appendChild(empty);
      return;
    }

    for (const lesson of state.lessons) {
      const wrap = document.createElement('div');
      wrap.className = 'item';

      const top = document.createElement('div');
      top.className = 'item-top';

      const left = document.createElement('div');
      left.style.display = 'grid';
      left.style.gap = '4px';

      const title = document.createElement('div');
      title.textContent = lesson.text;

      const meta = document.createElement('div');
      meta.className = 'muted';
      const learnedText = lesson.learned ? `Learned: ${fmtDate(lesson.learnedAt)}` : 'No learned';
      const dueText = lesson.learned ? `Due: ${fmtDate(lesson.dueAt)}` : 'Due: -';
      meta.textContent = `${learnedText} · ${dueText} · Reps: ${lesson.reps || 0}`;

      left.appendChild(title);
      left.appendChild(meta);

      const right = document.createElement('div');
      right.className = 'row';
      right.style.justifyContent = 'flex-end';

      const status = document.createElement('span');
      status.className = 'pill ' + (lesson.learned ? 'good' : '');
      status.textContent = lesson.learned ? 'learned' : 'new';

      const btnToggle = document.createElement('button');
      btnToggle.textContent = lesson.learned ? 'Unlearn' : 'Mark learned';
      btnToggle.dataset.action = 'toggle-learned';
      btnToggle.dataset.id = lesson.id;

      const btnDelete = document.createElement('button');
      btnDelete.className = 'danger';
      btnDelete.textContent = 'Delete';
      btnDelete.dataset.action = 'delete-lesson';
      btnDelete.dataset.id = lesson.id;

      right.appendChild(status);
      right.appendChild(btnToggle);
      right.appendChild(btnDelete);

      top.appendChild(left);
      top.appendChild(right);
      wrap.appendChild(top);

      el.lessonsList.appendChild(wrap);
    }
  }

  function renderReviews() {
    const learned = getLearnedLessons();
    const due = getDueLessons();
    const next = getNextReviewCandidate();

    el.duePill.textContent = `Due: ${due.length}`;
    el.queuePill.textContent = `Queue: ${learned.length}`;

    if (!next) {
      el.reviewPrompt.textContent = learned.length === 0
        ? 'No hay items para repasar. Marca alguna lección como learned.'
        : 'No hay items vencidos ahora. Vuelve cuando haya due.';
      el.reviewMeta.textContent = '';
      // Deshabilitar botones cuando no hay candidato evita “click sin efecto”
      for (const b of el.reviewButtons.querySelectorAll('button')) b.disabled = true;
      return;
    }

    el.reviewPrompt.textContent = next.text;
    el.reviewMeta.textContent = `Last grade: ${next.lastGrade ?? '-'} · Reps: ${next.reps || 0} · Due: ${fmtDate(next.dueAt)} · Learned: ${fmtDate(next.learnedAt)}`;

    for (const b of el.reviewButtons.querySelectorAll('button')) {
      b.disabled = false;
      b.dataset.id = next.id; // el “target” actual
    }
  }

  function renderAll() {
    renderStats();
    renderLessonsList();
    renderReviews();
  }

  // ----------------------------
  // Eventos (event delegation)
  // ----------------------------
  el.addLessonBtn.addEventListener('click', function () {
    addLesson(el.newLessonText.value);
    el.newLessonText.value = '';
    el.newLessonText.focus();
  });

  el.newLessonText.addEventListener('keydown', function (ev) {
    if (ev.key === 'Enter') {
      addLesson(el.newLessonText.value);
      el.newLessonText.value = '';
    }
  });

  el.lessonsList.addEventListener('click', function (ev) {
    const target = ev.target;
    if (!(target instanceof HTMLElement)) return;

    const action = target.dataset.action;
    const id = target.dataset.id;
    if (!action || !id) return;

    if (action === 'toggle-learned') toggleLearned(id);
    if (action === 'delete-lesson') deleteLesson(id);
  });

  el.reviewButtons.addEventListener('click', function (ev) {
    const target = ev.target;
    if (!(target instanceof HTMLButtonElement)) return;

    const grade = target.dataset.grade;
    const id = target.dataset.id; // viene del renderReviews()
    if (!grade || !id) return;

    applyReviewGrade(id, grade);
  });

  // ----------------------------
  // Backup (export/import/reset)
  // ----------------------------
  el.exportBtn.addEventListener('click', function () {
    el.backupArea.value = JSON.stringify(state, null, 2);
  });

  el.importBtn.addEventListener('click', function () {
    const raw = el.backupArea.value.trim();
    if (!raw) return;

    try {
      const parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.lessons)) return;

      // saneo mínimo: solo campos esperados
      const cleaned = parsed.lessons.map((l) => ({
        id: String(l.id || uid()),
        text: String(l.text || '').trim(),
        learned: Boolean(l.learned),
        createdAt: Number(l.createdAt || nowMs()),
        learnedAt: l.learned ? Number(l.learnedAt || nowMs()) : null,
        dueAt: l.learned ? Number(l.dueAt || nowMs()) : null,
        reps: Number(l.reps || 0),
        lastGrade: l.lastGrade ? String(l.lastGrade) : null
      })).filter(l => l.text);

      state = { lessons: cleaned };
      saveState();
      renderAll();
    } catch {
      // JSON inválido: no hacemos nada
    }
  });

  el.resetBtn.addEventListener('click', function () {
    // Reset sin confirmación para evitar diálogos bloqueantes; si quieres confirmación lo cambio.
    state = { lessons: [] };
    saveState();
    el.backupArea.value = '';
    renderAll();
  });

  // Inicial
  renderAll();
})();
</script>
</body>
</html>
