 <!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keinap - JLPT N5→N1</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7fb; color: #111; }
    header { padding: 16px; background: #111; color: #fff; }
    header .top { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    header h1 { margin: 0; font-size: 16px; }
    header .tabs { display:flex; gap:8px; flex-wrap:wrap; }

    main { max-width: 1080px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 1.2fr 0.8fr; }
    @media (max-width: 900px) { main { grid-template-columns: 1fr; } }

    .card { background: #fff; border: 1px solid #e7e7ee; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.05); overflow: hidden; }
    .card header { background: transparent; color: inherit; padding: 14px 14px 0 14px; }
    .card header h2 { margin: 0; font-size: 16px; }
    .card .content { padding: 14px; display: grid; gap: 10px; }

    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"], select {
      padding: 10px 12px; border: 1px solid #d9d9e6; border-radius: 10px; background:#fff;
    }
    input[type="text"] { flex: 1; min-width: 220px; }
    button { border: 1px solid #d0d0dd; background: #fff; padding: 10px 12px; border-radius: 10px; cursor: pointer; }
    button:hover { background: #f2f3f9; }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button.primary:hover { background: #222; }
    button.danger { border-color: #ffb3b3; }
    button.danger:hover { background: #fff0f0; }

    .tab {
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      color:#fff; padding:8px 10px; border-radius: 999px;
      cursor:pointer; user-select:none; font-size: 12px;
    }
    .tab.active { background:#fff; color:#111; border-color:#fff; }

    .muted { color: #666; font-size: 12px; }
    .list { display: grid; gap: 8px; }
    .item { border: 1px solid #ececf4; border-radius: 12px; padding: 10px; display: grid; gap: 8px; }
    .item-top { display: flex; justify-content: space-between; gap: 8px; align-items: center; }
    .pill { font-size: 12px; padding: 4px 8px; border: 1px solid #e3e3ef; border-radius: 999px; background: #fafafe; }
    .pill.good { border-color: #cde9d7; background: #f3fbf6; }
    .pill.due { border-color: #ffe3a6; background: #fff9ec; }

    .progress { height: 10px; background: #eee; border-radius: 999px; overflow: hidden; }
    .progress > div { height: 100%; width: 0%; background: #111; }

    .review-big { font-size: 15px; line-height: 1.35; }
    .btn-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    @media (max-width: 520px) { .btn-grid { grid-template-columns: 1fr 1fr; } }

    .kv { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .kv .box { border: 1px solid #ececf4; border-radius: 12px; padding: 10px; }
    .kv .box .k { font-size: 12px; color: #666; }
    .kv .box .v { font-size: 18px; font-weight: 700; margin-top: 2px; }

    textarea { width: 100%; min-height: 120px; padding: 10px 12px; border: 1px solid #d9d9e6; border-radius: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
  </style>
</head>
<body>
<header>
  <div class="top">
    <h1>Keinap — JLPT N5 → N1 (Lessons + Reviews)</h1>
    <div class="tabs" id="levelTabs"></div>
  </div>
</header>

<main>
  <section class="card">
    <header><h2>Lessons</h2></header>
    <div class="content">
      <div class="row">
        <select id="newLessonLevel" aria-label="Nivel JLPT">
          <option value="N5">N5</option>
          <option value="N4">N4</option>
          <option value="N3">N3</option>
          <option value="N2">N2</option>
          <option value="N1">N1</option>
        </select>
        <input id="newLessonText" type="text" placeholder="Nueva lección (ej: 行く (いく) – ir)" />
        <button class="primary" id="addLessonBtn">Agregar</button>
      </div>

      <div class="kv">
        <div class="box">
          <div class="k">Total (filtro actual)</div>
          <div class="v" id="statTotal">0</div>
        </div>
        <div class="box">
          <div class="k">Aprendidas (filtro actual)</div>
          <div class="v" id="statLearned">0</div>
        </div>
      </div>

      <div>
        <div class="muted" id="progressLabel">0% completado</div>
        <div class="progress"><div id="progressBar"></div></div>
      </div>

      <div class="list" id="lessonsList"></div>
    </div>
  </section>

  <section class="card">
    <header><h2>Reviews</h2></header>
    <div class="content">
      <div class="muted">
        Filtra por nivel seleccionado arriba. Solo se repasa lo “learned”.
        Intervalos: Again(0d), Hard(+1d), Good(+3d), Easy(+7d). Skip no cambia nada.
      </div>

      <div class="item">
        <div class="item-top">
          <span class="pill due" id="duePill">Due: 0</span>
          <span class="pill" id="queuePill">Queue: 0</span>
        </div>

        <div class="review-big" id="reviewPrompt">No hay items para repasar.</div>
        <div class="muted" id="reviewMeta"></div>

        <div class="btn-grid" id="reviewButtons">
          <button data-grade="again">Again</button>
          <button data-grade="hard">Hard</button>
          <button data-grade="good">Good</button>
          <button data-grade="easy">Easy</button>
          <button data-grade="skip">Skip</button>
        </div>
      </div>

      <div class="item">
        <div class="item-top"><div class="muted">Backup (export/import)</div></div>
        <div class="row">
          <button id="exportBtn">Exportar JSON</button>
          <button id="importBtn">Importar JSON</button>
          <button class="danger" id="resetBtn">Reset total</button>
        </div>
        <textarea id="backupArea" placeholder="Aquí aparece el JSON al exportar. Para importar: pega JSON válido y presiona Importar."></textarea>
      </div>
    </div>
  </section>
</main>

<script>
(function () {
  'use strict';

  // Estado: palabras reservadas usadas aquí: const, let, function, return, if, for, switch, case, break, try, catch, new.
  // No uses esos nombres como identificadores.

  const STORAGE_KEY = 'keinap_jlpt_v2';

  /** @typedef {'ALL'|'N5'|'N4'|'N3'|'N2'|'N1'} Level */
  /** @typedef {{ id:string, text:string, level:Level, learned:boolean, createdAt:number, learnedAt:number|null, dueAt:number|null, reps:number, lastGrade:string|null }} Lesson */
  /** @type {{ lessons: Lesson[], ui: { level: Level } }} */
  let state = loadState();

  const LEVELS = /** @type {Level[]} */ (['ALL','N5','N4','N3','N2','N1']);

  const el = {
    levelTabs: document.getElementById('levelTabs'),
    newLessonLevel: document.getElementById('newLessonLevel'),
    newLessonText: document.getElementById('newLessonText'),
    addLessonBtn: document.getElementById('addLessonBtn'),
    lessonsList: document.getElementById('lessonsList'),
    statTotal: document.getElementById('statTotal'),
    statLearned: document.getElementById('statLearned'),
    progressLabel: document.getElementById('progressLabel'),
    progressBar: document.getElementById('progressBar'),

    reviewPrompt: document.getElementById('reviewPrompt'),
    reviewMeta: document.getElementById('reviewMeta'),
    duePill: document.getElementById('duePill'),
    queuePill: document.getElementById('queuePill'),
    reviewButtons: document.getElementById('reviewButtons'),

    exportBtn: document.getElementById('exportBtn'),
    importBtn: document.getElementById('importBtn'),
    resetBtn: document.getElementById('resetBtn'),
    backupArea: document.getElementById('backupArea'),
  };

  function nowMs() { return Date.now(); }
  function daysToMs(days) { return days * 24 * 60 * 60 * 1000; }
  function uid() { return Math.random().toString(16).slice(2) + '-' + Math.random().toString(16).slice(2); }

  function normalizeLevel(x) {
    const v = String(x || '').toUpperCase();
    if (v === 'N5' || v === 'N4' || v === 'N3' || v === 'N2' || v === 'N1') return /** @type {Level} */ (v);
    return 'ALL';
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { lessons: [], ui: { level: 'ALL' } };

      const parsed = JSON.parse(raw);
      const lessons = Array.isArray(parsed.lessons) ? parsed.lessons : [];
      const uiLevel = parsed.ui && parsed.ui.level ? normalizeLevel(parsed.ui.level) : 'ALL';

      const cleaned = lessons.map((l) => ({
        id: String(l.id || uid()),
        text: String(l.text || '').trim(),
        level: normalizeLevel(l.level || 'N5'),
        learned: Boolean(l.learned),
        createdAt: Number(l.createdAt || nowMs()),
        learnedAt: l.learned ? Number(l.learnedAt || nowMs()) : null,
        dueAt: l.learned ? Number(l.dueAt || nowMs()) : null,
        reps: Number(l.reps || 0),
        lastGrade: l.lastGrade ? String(l.lastGrade) : null
      })).filter(l => l.text);

      return { lessons: cleaned, ui: { level: uiLevel } };
    } catch {
      return { lessons: [], ui: { level: 'ALL' } };
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function fmtDate(ms) {
    if (!ms) return '-';
    const d = new Date(ms);
    return d.toLocaleString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
  }

  function getFilteredLessons() {
    const lvl = state.ui.level;
    if (lvl === 'ALL') return state.lessons;
    return state.lessons.filter(l => l.level === lvl);
  }

  function addLesson(text, level) {
    const trimmed = String(text || '').trim();
    if (!trimmed) return;

    /** @type {Lesson} */
    const lesson = {
      id: uid(),
      text: trimmed,
      level: normalizeLevel(level || 'N5'),
      learned: false,
      createdAt: nowMs(),
      learnedAt: null,
      dueAt: null,
      reps: 0,
      lastGrade: null
    };

    state.lessons.unshift(lesson);
    saveState();
    renderAll();
  }

  function toggleLearned(id) {
    const lesson = state.lessons.find(l => l.id === id);
    if (!lesson) return;

    lesson.learned = !lesson.learned;

    if (lesson.learned) {
      lesson.learnedAt = nowMs();
      lesson.dueAt = nowMs(); // due inmediato
      lesson.reps = lesson.reps || 0;
      lesson.lastGrade = lesson.lastGrade || null;
    } else {
      lesson.learnedAt = null;
      lesson.dueAt = null;
      lesson.reps = 0;
      lesson.lastGrade = null;
    }

    saveState();
    renderAll();
  }

  function deleteLesson(id) {
    state.lessons = state.lessons.filter(l => l.id !== id);
    saveState();
    renderAll();
  }

  function getLearnedFiltered() {
    return getFilteredLessons().filter(l => l.learned);
  }

  function getDueFiltered() {
    const t = nowMs();
    return getLearnedFiltered().filter(l => (l.dueAt ?? 0) <= t);
  }

  function getNextReviewCandidate() {
    const due = getDueFiltered()
      .slice()
      .sort((a, b) => (a.dueAt ?? 0) - (b.dueAt ?? 0) || a.createdAt - b.createdAt);
    return due.length ? due[0] : null;
  }

  function applyReviewGrade(id, grade) {
    const lesson = state.lessons.find(l => l.id === id);
    if (!lesson || !lesson.learned) return;

    if (grade === 'skip') {
      saveState();
      renderAll();
      return;
    }

    const intervals = { again: 0, hard: 1, good: 3, easy: 7 };
    const addDays = intervals[grade];
    if (typeof addDays !== 'number') return;

    const t = nowMs();
    lesson.reps = (lesson.reps || 0) + 1;
    lesson.lastGrade = grade;
    lesson.dueAt = t + daysToMs(addDays);

    saveState();
    renderAll();
  }

  function renderTabs() {
    el.levelTabs.innerHTML = '';
    for (const lvl of LEVELS) {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'tab' + (state.ui.level === lvl ? ' active' : '');
      b.dataset.level = lvl;
      b.textContent = (lvl === 'ALL') ? 'Todos' : lvl;
      el.levelTabs.appendChild(b);
    }

    // sincroniza el selector de "nuevo lesson" con el filtro (si el filtro es N*)
    if (state.ui.level !== 'ALL') el.newLessonLevel.value = state.ui.level;
  }

  function renderStats() {
    const lessons = getFilteredLessons();
    const total = lessons.length;
    const learned = lessons.filter(l => l.learned).length;

    el.statTotal.textContent = String(total);
    el.statLearned.textContent = String(learned);

    const pct = total === 0 ? 0 : Math.round((learned / total) * 100);
    el.progressLabel.textContent = `${pct}% completado`;
    el.progressBar.style.width = `${pct}%`;
  }

  function renderLessonsList() {
    const lessons = getFilteredLessons();
    el.lessonsList.innerHTML = '';

    if (lessons.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = state.ui.level === 'ALL'
        ? 'No hay lecciones todavía.'
        : `No hay lecciones en ${state.ui.level}.`;
      el.lessonsList.appendChild(empty);
      return;
    }

    for (const lesson of lessons) {
      const wrap = document.createElement('div');
      wrap.className = 'item';

      const top = document.createElement('div');
      top.className = 'item-top';

      const left = document.createElement('div');
      left.style.display = 'grid';
      left.style.gap = '4px';

      const title = document.createElement('div');
      title.textContent = lesson.text;

      const meta = document.createElement('div');
      meta.className = 'muted';
      const learnedText = lesson.learned ? `Learned: ${fmtDate(lesson.learnedAt)}` : 'No learned';
      const dueText = lesson.learned ? `Due: ${fmtDate(lesson.dueAt)}` : 'Due: -';
      meta.textContent = `${lesson.level} · ${learnedText} · ${dueText} · Reps: ${lesson.reps || 0}`;

      left.appendChild(title);
      left.appendChild(meta);

      const right = document.createElement('div');
      right.className = 'row';
      right.style.justifyContent = 'flex-end';

      const status = document.createElement('span');
      status.className = 'pill ' + (lesson.learned ? 'good' : '');
      status.textContent = lesson.learned ? 'learned' : 'new';

      const btnToggle = document.createElement('button');
      btnToggle.textContent = lesson.learned ? 'Unlearn' : 'Mark learned';
      btnToggle.dataset.action = 'toggle-learned';
      btnToggle.dataset.id = lesson.id;

      const btnDelete = document.createElement('button');
      btnDelete.className = 'danger';
      btnDelete.textContent = 'Delete';
      btnDelete.dataset.action = 'delete-lesson';
      btnDelete.dataset.id = lesson.id;

      right.appendChild(status);
      right.appendChild(btnToggle);
      right.appendChild(btnDelete);

      top.appendChild(left);
      top.appendChild(right);
      wrap.appendChild(top);

      el.lessonsList.appendChild(wrap);
    }
  }

  function renderReviews() {
    const learned = getLearnedFiltered();
    const due = getDueFiltered();
    const next = getNextReviewCandidate();

    el.duePill.textContent = `Due: ${due.length}`;
    el.queuePill.textContent = `Queue: ${learned.length}`;

    if (!next) {
      el.reviewPrompt.textContent = learned.length === 0
        ? 'No hay items para repasar. Marca alguna lección como learned.'
        : 'No hay items vencidos ahora. Vuelve cuando haya due.';
      el.reviewMeta.textContent = '';
      for (const b of el.reviewButtons.querySelectorAll('button')) b.disabled = true;
      return;
    }

    el.reviewPrompt.textContent = next.text;
    el.reviewMeta.textContent =
      `${next.level} · Last grade: ${next.lastGrade ?? '-'} · Reps: ${next.reps || 0} · Due: ${fmtDate(next.dueAt)} · Learned: ${fmtDate(next.learnedAt)}`;

    for (const b of el.reviewButtons.querySelectorAll('button')) {
      b.disabled = false;
      b.dataset.id = next.id;
    }
  }

  function renderAll() {
    renderTabs();
    renderStats();
    renderLessonsList();
    renderReviews();
  }

  // Eventos
  el.levelTabs.addEventListener('click', function (ev) {
    const t = ev.target;
    if (!(t instanceof HTMLElement)) return;
    const lvl = t.dataset.level;
    if (!lvl) return;

    state.ui.level = normalizeLevel(lvl);
    saveState();
    renderAll();
  });

  el.addLessonBtn.addEventListener('click', function () {
    addLesson(el.newLessonText.value, el.newLessonLevel.value);
    el.newLessonText.value = '';
    el.newLessonText.focus();
  });

  el.newLessonText.addEventListener('keydown', function (ev) {
    if (ev.key === 'Enter') {
      addLesson(el.newLessonText.value, el.newLessonLevel.value);
      el.newLessonText.value = '';
    }
  });

  el.lessonsList.addEventListener('click', function (ev) {
    const t = ev.target;
    if (!(t instanceof HTMLElement)) return;

    const action = t.dataset.action;
    const id = t.dataset.id;
    if (!action || !id) return;

    if (action === 'toggle-learned') toggleLearned(id);
    if (action === 'delete-lesson') deleteLesson(id);
  });

  el.reviewButtons.addEventListener('click', function (ev) {
    const t = ev.target;
    if (!(t instanceof HTMLButtonElement)) return;

    const grade = t.dataset.grade;
    const id = t.dataset.id;
    if (!grade || !id) return;

    applyReviewGrade(id, grade);
  });

  // Backup
  el.exportBtn.addEventListener('click', function () {
    el.backupArea.value = JSON.stringify(state, null, 2);
  });

  el.importBtn.addEventListener('click', function () {
    const raw = el.backupArea.value.trim();
    if (!raw) return;

    try {
      const parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.lessons)) return;

      const cleaned = parsed.lessons.map((l) => ({
        id: String(l.id || uid()),
        text: String(l.text || '').trim(),
        level: normalizeLevel(l.level || 'N5'),
        learned: Boolean(l.learned),
        createdAt: Number(l.createdAt || nowMs()),
        learnedAt: l.learned ? Number(l.learnedAt || nowMs()) : null,
        dueAt: l.learned ? Number(l.dueAt || nowMs()) : null,
        reps: Number(l.reps || 0),
        lastGrade: l.lastGrade ? String(l.lastGrade) : null
      })).filter(l => l.text);

      const uiLevel = parsed.ui && parsed.ui.level ? normalizeLevel(parsed.ui.level) : state.ui.level;

      state = { lessons: cleaned, ui: { level: uiLevel } };
      saveState();
      renderAll();
    } catch {
      // JSON inválido: no hace nada
    }
  });

  el.resetBtn.addEventListener('click', function () {
    state = { lessons: [], ui: { level: 'ALL' } };
    saveState();
    el.backupArea.value = '';
    renderAll();
  });

  renderAll();
})();
</script>
</body>
</html>
